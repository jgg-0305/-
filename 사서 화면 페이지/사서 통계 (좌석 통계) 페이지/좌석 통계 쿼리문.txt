--- 데이터 조회 ---
-- 기간별/월별 좌석 점유율 조회
-- (최근 1개월 간의 일별 좌석 이용 횟수 조회)
SELECT
    DATE(log_time) AS log_date,
    COUNT(CASE WHEN log_type = 'SEAT_IN' THEN 1 END) AS entry_count,
    COUNT(CASE WHEN log_type = 'SEAT_OUT' THEN 1 END) AS exit_count
FROM
    entry_logs
WHERE
    log_time >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
    AND log_type IN ('SEAT_IN', 'SEAT_OUT')
GROUP BY
    log_date
ORDER BY
    log_date ASC;

-- 시간대별 좌석 이용 현황 조회
SELECT
    HOUR(log_time) AS log_hour,
    COUNT(*) AS total_entries
FROM
    entry_logs
WHERE
    log_type = 'SEAT_IN'
    AND log_time >= DATE_SUB(CURDATE(), INTERVAL 1 WEEK) -- 예시: 최근 1주간 데이터
GROUP BY
    log_hour
ORDER BY
    log_hour ASC;

-- 사용자별 이용 시간 순위 조회
SELECT
    T1.usr_id,
    T2.usr_name,
    SUM(TIMESTAMPDIFF(MINUTE, T1.start_time, T1.end_time)) AS total_usage_minutes
FROM
    (
        -- SEAT_IN과 SEAT_OUT의 짝을 맞추는 서브쿼리
        SELECT
            e1.usr_id, e1.log_time AS start_time,
            (SELECT MIN(e2.log_time) FROM entry_logs e2
             WHERE e2.usr_id = e1.usr_id AND e2.log_type = 'SEAT_OUT' AND e2.log_time > e1.log_time) AS end_time
        FROM
            entry_logs e1
        WHERE
            e1.log_type = 'SEAT_IN'
    ) T1
JOIN
    users T2 ON T1.usr_id = T2.usr_id
WHERE
    T1.end_time IS NOT NULL -- 퇴실 기록이 있는 경우만 계산
GROUP BY
    T1.usr_id, T2.usr_name
ORDER BY
    total_usage_minutes DESC
LIMIT 10;

-- 구역별 선호도 조회
SELECT
    T3.loc_name AS 열람실_구역명,
    COUNT(T1.log_id) AS 총_이용_횟수,
    -- 전체 이용 기록 대비 해당 구역의 비율 계산
    ROUND(
        COUNT(T1.log_id) * 100.0 / (
            SELECT COUNT(*)
            FROM entry_logs
            WHERE log_type = 'SEAT_IN'
              AND log_time >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
        ), 2
    ) AS 이용_점유율_퍼센트
FROM
    entry_logs T1
JOIN
    seats T2 ON SUBSTRING_INDEX(T1.log_varchar, 'seat_id: ', -1) = T2.seat_id -- 로그 문자열에서 seat_id 추출
JOIN
    locations T3 ON T2.loc_id = T3.loc_id
WHERE
    T1.log_type = 'SEAT_IN' -- 입실(이용 시작) 기록만 카운트
    AND T1.log_time >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH) -- (최근 6개월 데이터 기준)
GROUP BY
    T3.loc_name, T3.loc_id
ORDER BY
    총_이용_횟수 DESC;

--- 인덱스 생성 ---
-- 좌석 현황 통계 계산 최적화
CREATE INDEX idx_seats_loc_stat
ON seats (loc_id, seat_stat);

-- 기간별/유형별 출입 로그 조회를 위한 인덱스
CREATE INDEX idx_entrylogs_time_type
ON entry_logs (log_time, log_type);

-- 사용자별 출입 기록 검색 및 이용 시간 계산을 위한 인덱스
CREATE INDEX idx_entrylogs_usr_id_time
ON entry_logs (usr_id, log_time);

-----------------------------------------------------------------------------

-- 1. [기간별 통계] 일별 좌석 이용 건수 조회 (Line Chart용)
-- 화면: '기간별 평균 좌석 점유율' 차트 데이터
-- 설명: 최근 1개월간 일별 총 예약(이용) 횟수를 조회합니다.
SELECT 
    DATE(res_start) AS log_date,
    COUNT(*) AS total_usage_count
FROM 
    seat_reservations
WHERE 
    res_start >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
GROUP BY 
    DATE(res_start)
ORDER BY 
    log_date ASC;


-- 2. [시간대별 통계] 시간대별 좌석 이용 시작 분포 (Bar Chart용)
-- 화면: '시간대별 이용률 (Peak Time)' 차트 데이터
-- 설명: 최근 1주간 데이터 기준, 가장 많이 이용을 시작한 시간대를 추출합니다.
SELECT 
    HOUR(res_start) AS log_hour,
    COUNT(*) AS total_entries
FROM 
    seat_reservations
WHERE 
    res_start >= DATE_SUB(CURDATE(), INTERVAL 1 WEEK) 
GROUP BY 
    log_hour
ORDER BY 
    log_hour ASC;


-- 3. [구역별 통계] 열람실 구역별 선호도 조회 (Horizontal Bar Chart용)
-- 화면: '구역별 선호도 비교' 차트 데이터
-- 설명: 좌석 테이블(seats)과 조인하여 어떤 열람실이 가장 많이 이용되었는지 집계합니다.

SELECT 
    S.seat_room AS room_name,       -- 제1열람실, 제2열람실 등 (ENUM)
    COUNT(R.res_id) AS total_usage, -- 총 이용 횟수
    -- 전체 대비 비율 계산 (퍼센트)
    ROUND(
        COUNT(R.res_id) * 100.0 / (
            SELECT COUNT(*) 
            FROM seat_reservations 
            WHERE res_start >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
        ), 2
    ) AS usage_percent
FROM 
    seat_reservations R
JOIN 
    seats S ON R.seat_id = S.seat_id
WHERE 
    R.res_start >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
GROUP BY 
    S.seat_room
ORDER BY 
    total_usage DESC;


-- 4. [사용자 랭킹] 최다 이용 시간 사용자 순위 (Table용)
-- 화면: 사용자별 이용 시간 순위 리스트
-- 설명: 입실(res_start)과 퇴실(res_end) 차이를 계산하여 합산합니다.
-- 수정사항: 성능을 저하시키는 상관 서브쿼리 제거 -> 단순 집계 함수 사용
SELECT 
    U.usr_id,
    U.usr_name,
    U.usr_dept, -- 학과 정보 추가 (동명이인 구분 및 통계용)
    -- 이용 시간 합계 (분 단위). 퇴실 시간이 없으면(현재 이용중) 현재 시간 기준으로 계산
    SUM(TIMESTAMPDIFF(MINUTE, R.res_start, IFNULL(R.res_end, NOW()))) AS total_minutes,
    -- 보기 좋게 '시간:분' 형식으로 변환 (선택사항)
    CONCAT(
        FLOOR(SUM(TIMESTAMPDIFF(MINUTE, R.res_start, IFNULL(R.res_end, NOW()))) / 60), '시간 ',
        MOD(SUM(TIMESTAMPDIFF(MINUTE, R.res_start, IFNULL(R.res_end, NOW()))), 60), '분'
    ) AS view_duration
FROM 
    seat_reservations R
JOIN 
    users U ON R.usr_id = U.usr_id
WHERE 
    R.res_start >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH) -- 최근 1개월 랭킹
GROUP BY 
    U.usr_id, U.usr_name, U.usr_dept
ORDER BY 
    total_minutes DESC
LIMIT 10;


-- 5. [성능 최적화] 통계 조회 속도 향상을 위한 인덱스 추가
-- 설명: 위 쿼리들이 빠르게 실행되도록 seat_reservations 테이블에 인덱스를 겁니다.

-- 날짜별 조회를 빠르게 (쿼리 1, 2번용)
CREATE INDEX idx_seat_res_date ON seat_reservations (res_start);

-- 특정 좌석/구역별 조회를 빠르게 (쿼리 3번용)
CREATE INDEX idx_seat_res_seat ON seat_reservations (seat_id, res_start);

-- 사용자별 통계 조회를 빠르게 (쿼리 4번용)
CREATE INDEX idx_seat_res_user ON seat_reservations (usr_id, res_start);









