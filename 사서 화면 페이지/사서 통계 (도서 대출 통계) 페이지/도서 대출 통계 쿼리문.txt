--- 데이터 조회 ---
-- 전체 도서 대출 현황 조회(최근 12개월)
SELECT
    YEAR(loan_date) AS loan_year,
    MONTH(loan_date) AS loan_month,
    COUNT(loan_id) AS total_loans
FROM
    loans
WHERE
    YEAR(loan_date) = YEAR(CURDATE())  // 수정함
GROUP BY
    YEAR(loan_date), MONTH(loan_date) WITH ROLLUP  // 수정함 (해당 년도 총대출건수 집계하기 위함)
ORDER BY
    loan_year ASC, loan_month ASC;

-- 도서 대출 순위 조회
SELECT
    T3.bk_title AS 서명,
    COUNT(T1.loan_id) AS total_loan_count
FROM
    loans T1
JOIN
    book_copies T2 ON T1.cbk_id = T2.cbk_id
JOIN
    books T3 ON T2.bk_id = T3.bk_id
GROUP BY
    T3.bk_id, T3.bk_title
ORDER BY
    total_loan_count DESC
LIMIT 5; -- 예시: Top 5 도서 조회

-- 주제별 대출 비율
SELECT
    T4.gnr_name AS genre_name,
    COUNT(T1.loan_id) AS total_loan_count 
FROM
    loans T1
JOIN
    book_copies T2 ON T1.cbk_id = T2.cbk_id
JOIN
    books T3 ON T2.bk_id = T3.bk_id            
JOIN
    genres T4 ON T3.gnr_id = T4.gnr_id         
GROUP BY
    T4.gnr_name                                  
ORDER BY
    total_loan_count DESC;

-- 특정 도서 상세 통계 조회


--- 인덱스 생성 ---
-- 월별/기간별 대출 집계 속도 향상을 위한 인덱스
CREATE INDEX idx_loans_date
ON loans (loan_date);

-- 도서 순위 계산을 위한 조인 조건 최적화 
CREATE INDEX idx_loans_cbk_id
ON loans (cbk_id);

CREATE INDEX idx_copies_bk_id
ON book_copies (bk_id);

-- 특정 도서의 월별 통계 조회 가속화
CREATE INDEX idx_monthly_stats_bk_id_ym
ON monthly_book_stats (bk_id, stat_year, stat_month);
