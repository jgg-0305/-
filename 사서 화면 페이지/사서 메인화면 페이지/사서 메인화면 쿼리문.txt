--- 데이터 조회 ---
-- 사서 기본 정보 조회
SELECT
    lib_name
FROM
    librarians
WHERE
    lib_id = '로그인한_사서_ID';

-- 신규 희망자료 신청 건수 조회
SELECT
    COUNT(*) AS new_request_count
FROM
    requests
WHERE
    req_stat = '접수대기'; -- 사서의 검토를 기다리는 초기 상태

-- 미반납 연체 도서 건수
SELECT
    COUNT(T1.loan_id) AS overdue_loan_count
FROM
    loans T1
WHERE
    T1.loan_ret IS NULL -- 반납되지 않음
    AND T1.loan_due < CURDATE(); -- 반납 예정일이 오늘 이전

-- 신규 상호대차 신청 건수
SELECT
    COUNT(*) AS new_ill_count
FROM
    inter_library_loans
WHERE
    ill_stat = '신청완료'; -- 사서의 처리를 기다리는 초기 상태

-- 최근 공지사항 목록 조회
SELECT
    ntc_title,
    DATE_FORMAT(ntc_date, '%m.%d') AS n_date -- 날짜를 '월.일' 형식으로 포맷
FROM
    notices
ORDER BY
    ntc_date DESC, ntc_id DESC
LIMIT 3; -- 메인 화면에 3개만 표시

--- 인덱스 생성 ---
-- 희망자료 신청 상태별 조회를 위한 인덱스
CREATE INDEX idx_requests_stat
ON requests (req_stat);

-- 연체 도서 확인을 위한 인덱스
CREATE INDEX idx_loans_due_ret
ON loans (loan_ret, loan_due);

-- 상호대차 신청 상태별 조회를 위한 인덱스
CREATE INDEX idx_ill_stat
ON inter_library_loans (ill_stat);

-- 공지사항 최신순 정렬을 위한 인덱스
CREATE INDEX idx_notices_date_desc
ON notices (ntc_date DESC);


-------------------------------------------

-- 1. [헤더] 사서 이름 조회
SELECT lib_name FROM librarians WHERE lib_id = 'admin01';


-- 2. [상단 카드] 업무 현황 카운트 (ENUM 값 DDL 일치화)
-- 설명: 각 업무별 '처리 대기' 상태인 건수를 조회합니다.

-- 2-1. 상호대차 신청 대기 (ILL)
SELECT COUNT(*) AS cnt_ill 
FROM inter_library_loans 
WHERE ill_stat = '신청중'; -- DDL 기준 '신청중'

-- 2-2. 희망도서 승인 대기 (Request)
SELECT COUNT(*) AS cnt_req 
FROM requests 
WHERE req_stat = '대기';   -- DDL 기준 '대기'

-- 2-3. [NEW] 봉사활동 신청 대기 (Volunteer) - 쿼리 추가됨
SELECT COUNT(*) AS cnt_vol 
FROM volunteer_activities 
WHERE vol_stat = '대기';

-- 2-4. 현재 연체 중인 '회원' 수
-- 설명: 한 사람이 여러 권을 연체해도 1명으로 카운트
SELECT COUNT(DISTINCT usr_id) AS cnt_overdue_users
FROM loans
WHERE loan_ret IS NULL      -- 반납 안 함
  AND loan_due < CURDATE(); -- 반납일 지남


-- 통합 업무 리스트 조회 (신청일 오름차순)

SELECT 
    T.work_type AS '구분',         -- 상호대차/희망도서/봉사활동
    T.title AS '내용',             -- 책 제목 또는 활동 내용
    U.usr_name AS '신청자',        -- 신청자 이름
    T.reg_date AS '신청일'         -- 신청 날짜
FROM 
    (
        -- 1. 상호대차 (신청중인 것만)
        SELECT 
            '상호대차' AS work_type,
            ill_title AS title,
            ill_req_date AS reg_date,
            usr_id
        FROM inter_library_loans 
        WHERE ill_stat = '신청중'
        
        UNION ALL
        
        -- 2. 희망도서 (대기중인 것만)
        SELECT 
            '희망도서' AS work_type,
            req_title AS title,
            req_date AS reg_date,  -- DATETIME으로 자동 형변환됨
            usr_id
        FROM requests 
        WHERE req_stat = '대기'
        
        UNION ALL
        
        -- 3. 봉사활동 (대기중인 것만)
        SELECT 
            '봉사활동' AS work_type,
            vol_desc AS title,     -- 제목 대신 활동 내용 표시
            vol_date AS reg_date,
            usr_id
        FROM volunteer_activities 
        WHERE vol_stat = '대기'
    ) AS T
JOIN 
    users U ON T.usr_id = U.usr_id  -- 신청자 이름을 가져오기 위해 조인
ORDER BY 
    T.reg_date ASC  -- [핵심] 날짜 오름차순 (오래된 날짜가 가장 먼저 나옴)
LIMIT 5;            -- 화면에 보여줄 개수



-- 4. [우측 하단] 최근 공지사항 (미니 리스트)
SELECT 
    ntc_title,
    DATE_FORMAT(ntc_date, '%m.%d') AS ntc_date_fmt
FROM notices
ORDER BY ntc_date DESC
LIMIT 3;




