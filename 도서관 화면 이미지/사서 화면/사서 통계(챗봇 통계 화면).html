<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìŠ¤ë§ˆíŠ¸ ë¶„ì„ - ë™ì˜ëŒ€ ë„ì„œê´€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- [ê¸°ì¡´ ê³µí†µ ìŠ¤íƒ€ì¼] --- */
        :root {
            --primary-blue: #2552e3;
            --ai-purple: #6c5ce7; /* AI ì „ìš© ì»¬ëŸ¬ */
            --admin-dark: #1e293b; 
            --bg-gray: #f1f5f9;
            --text-dark: #333;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-gray); color: var(--text-dark); }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        header { background: #fff; padding: 15px 0; border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 22px; font-weight: 700; color: var(--admin-dark); display: flex; align-items: center; gap: 10px; }
        .admin-badge { background: var(--admin-dark); color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .logout-btn { font-size: 14px; color: #666; font-weight: 500; }

        .admin-layout { display: flex; gap: 30px; padding: 30px 0; height: calc(100vh - 70px); /* ê½‰ ì°¬ ë†’ì´ */ }
        .sidebar { width: 250px; flex-shrink: 0; background: #fff; border-radius: 8px; box-shadow: var(--card-shadow); height: fit-content; }
        .sidebar-title { background: var(--admin-dark); color: #fff; padding: 15px 20px; font-weight: 700; font-size: 16px; border-radius: 8px 8px 0 0; }
        .menu-list a { display: block; padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 14px; color: #444; transition: 0.2s; }
        .menu-list a:hover { background: #f8f9fa; color: var(--primary-blue); padding-left: 25px; }
        .menu-list i { width: 25px; text-align: center; margin-right: 5px; color: #8898aa; }
        
        /* AI ë©”ë‰´ ê°•ì¡° */
        .menu-ai { background: #f3e5f5; color: var(--ai-purple) !important; font-weight: 700; border-left: 4px solid var(--ai-purple); padding-left: 21px !important; }
        .menu-ai i { color: var(--ai-purple) !important; }

        /* --- [AI ë¶„ì„ í˜ì´ì§€ ì „ìš© ë ˆì´ì•„ì›ƒ] --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--admin-dark); display: flex; align-items: center; gap: 10px; }
        .ai-tag { background: var(--ai-purple); color: #fff; font-size: 12px; padding: 3px 8px; border-radius: 12px; font-weight: 500; }

        /* í™”ë©´ ë¶„í•  (ì¢Œ: ì±„íŒ… / ìš°: ê²°ê³¼) */
        .ai-layout { display: flex; gap: 20px; height: 100%; overflow: hidden; }
        
        /* 1. ì±„íŒ… ì˜ì—­ */
        .chat-panel { width: 400px; background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .chat-header { background: #f8fafc; padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #fff; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; position: relative; }
        .msg-ai { background: #f3f0ff; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-user { background: var(--ai-purple); color: #fff; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-time { font-size: 11px; color: #999; margin-top: 4px; display: block; text-align: right; }

        .chat-input-area { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: 0.2s; }
        .chat-input:focus { border-color: var(--ai-purple); }
        .btn-send { background: var(--ai-purple); color: #fff; border: none; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .btn-send:hover { background: #5649c0; }

        /* 2. ê²°ê³¼ ì‹œê°í™” ì˜ì—­ */
        .result-panel { flex: 1; background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; padding: 30px; border: 1px solid #e2e8f0; align-items: center; justify-content: center; position: relative; }
        
        /* ì´ˆê¸° ìƒíƒœ (ë°ì´í„° ì—†ìŒ) */
        .empty-state { text-align: center; color: #94a3b8; }
        .empty-icon { font-size: 60px; margin-bottom: 20px; color: #cbd5e1; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ (ê²°ê³¼ ìˆì„ ë•Œ) */
        .chart-wrapper { width: 100%; height: 100%; display: none; flex-direction: column; }
        .chart-info { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .chart-sql { font-family: 'Courier New', monospace; background: #1e293b; color: #00ff88; padding: 10px; border-radius: 6px; font-size: 12px; margin-top: 10px; display: none; }
        .chart-canvas-box { flex: 1; position: relative; width: 100%; }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .thinking-box { display: none; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--ai-purple); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .process-text { font-size: 14px; color: #666; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    </style>
</head>
<body>

    <header>
        <div class="container header-inner">
            <a href="index.html" class="logo">
                <i class="fa-solid fa-book-open"></i> ë™ì˜ëŒ€ ë„ì„œê´€ <span class="admin-badge">ADMIN</span>
            </a>
            <div>
                <span style="margin-right: 20px; font-size: 14px;">ê´€ë¦¬ì <b>í™ê¸¸ë™</b>ë‹˜ ì ‘ì†ì¤‘</span>
                <a href="index.html" class="logout-btn"><i class="fa-solid fa-arrow-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </header>

    <div class="container admin-layout">
        <aside class="sidebar">
            <div class="sidebar-title">ì‚¬ì„œ ê´€ë¦¬ ë©”ë‰´</div>
            <nav class="menu-list">
                <a href="librarian_final_v3.html"><i class="fa-solid fa-book"></i> ë„ì„œ ê²€ìƒ‰/ëŒ€ì¶œ ê´€ë¦¬</a>
                <a href="admin_ill_management.html"><i class="fa-solid fa-arrow-right-arrow-left"></i> ìƒí˜¸ëŒ€ì°¨ ì‹ ì²­ ê´€ë¦¬</a>
                <a href="admin_purchase_request.html"><i class="fa-solid fa-cart-plus"></i> í¬ë§ë„ì„œ ì‹ ì²­ ê´€ë¦¬</a>
                <a href="admin_student_list.html"><i class="fa-solid fa-users"></i> í•™ìƒ(íšŒì›) ê´€ë¦¬</a>
                <a href="admin_statistics.html"><i class="fa-solid fa-chart-pie"></i> ë„ì„œê´€ í†µê³„</a>
                <a href="admin_ai_analytics.html" class="menu-ai"><i class="fa-solid fa-wand-magic-sparkles"></i> AI ìŠ¤ë§ˆíŠ¸ ë¶„ì„</a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <div class="page-title">
                    <i class="fa-solid fa-wand-magic-sparkles" style="color:var(--ai-purple);"></i>
                    AI ìŠ¤ë§ˆíŠ¸ í†µê³„ ë¶„ì„
                    <span class="ai-tag">Beta</span>
                </div>
            </div>

            <div class="ai-layout">
                
                <div class="chat-panel">
                    <div class="chat-header">
                        <i class="fa-solid fa-robot" style="color:var(--ai-purple);"></i> Library AI Assistant
                    </div>
                    <div class="chat-messages" id="chatBox">
                        <div class="message msg-ai">
                            ì•ˆë…•í•˜ì„¸ìš”! ë„ì„œê´€ ë°ì´í„° AI ë¹„ì„œì…ë‹ˆë‹¤. ğŸ¤–<br>
                            ê¶ê¸ˆí•˜ì‹  í†µê³„ ì •ë³´ë¥¼ ë¬¼ì–´ë³´ì‹œë©´, DBë¥¼ ë¶„ì„í•˜ì—¬ ì‹œê°í™”í•´ë“œë¦½ë‹ˆë‹¤.<br><br>
                            ì˜ˆì‹œ:<br>
                            - "í•™ê³¼ë³„ ëŒ€ì¶œ í˜„í™© ë³´ì—¬ì¤˜"<br>
                            - "ì´ë²ˆ ë‹¬ ì¼ë³„ ë°©ë¬¸ì ìˆ˜ëŠ”?"<br>
                            - "ê°€ì¥ ë§ì´ ë¹Œë¦° ì±… Top 5"
                            <span class="msg-time">ì˜¤ì „ 09:00</span>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="userInput" class="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()">
                        <button class="btn-send" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>

                <div class="result-panel" id="resultPanel">
                    
                    <div id="emptyState" class="empty-state">
                        <i class="fa-solid fa-chart-simple empty-icon"></i>
                        <h3>ë°ì´í„° ë¶„ì„ ëŒ€ê¸°ì¤‘</h3>
                        <p>ì¢Œì¸¡ ì±„íŒ…ì°½ì— í†µê³„ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    </div>

                    <div id="loadingState" class="thinking-box">
                        <div class="spinner"></div>
                        <div class="process-text" id="processText">ì§ˆë¬¸ ë¶„ì„ ì¤‘...</div>
                    </div>

                    <div id="chartState" class="chart-wrapper">
                        <div class="chart-info">
                            <h3 id="chartTitle" style="color:#333; margin-bottom:5px;">ë¶„ì„ ê²°ê³¼ ì œëª©</h3>
                            <p id="chartDesc" style="color:#666; font-size:14px;">ì„¤ëª… í…ìŠ¤íŠ¸</p>
                            <div class="chart-sql" id="sqlBox">
                                SELECT department, COUNT(*) as loan_count <br>
                                FROM loan_history <br>
                                WHERE loan_date BETWEEN '2025-01-01' AND '2025-12-31' <br>
                                GROUP BY department;
                            </div>
                        </div>
                        <div class="chart-canvas-box">
                            <canvas id="aiChart"></canvas>
                        </div>
                    </div>

                </div>

            </div>

        </main>
    </div>

    <script>
        let currentChart = null;

        function sendMessage() {
            const inputField = document.getElementById('userInput');
            const message = inputField.value.trim();
            if (!message) return;

            // 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, 'user');
            inputField.value = '';

            // 2. UI ìƒíƒœ ë³€ê²½ (ë¡œë”© ì‹œì‘)
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('chartState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';

            // 3. LLM ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜ (ë‹¨ê³„ë³„ í…ìŠ¤íŠ¸ ë³€ê²½)
            const processText = document.getElementById('processText');
            
            setTimeout(() => { processText.innerText = "í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ìŠ¤ìº” ì¤‘..."; }, 800);
            setTimeout(() => { processText.innerText = "SQL ì¿¼ë¦¬ ìƒì„± ì¤‘..."; }, 1600);
            setTimeout(() => { processText.innerText = "ë°ì´í„° ì¶”ì¶œ ë° ì‹œê°í™” ì¤‘..."; }, 2400);

            // 4. ê²°ê³¼ ì¶œë ¥ (3ì´ˆ í›„)
            setTimeout(() => {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('chartState').style.display = 'flex';
                
                // AI ì‘ë‹µ ë©”ì‹œì§€ ì¶”ê°€
                addMessage("ìš”ì²­í•˜ì‹  ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì°¨íŠ¸ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.", 'ai');

                // ì°¨íŠ¸ ê·¸ë¦¬ê¸° ë¡œì§ í˜¸ì¶œ
                generateChart(message);
            }, 3000);
        }

        function addMessage(text, type) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message msg-${type}`;
            
            const time = new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute:'2-digit'});
            div.innerHTML = `${text} <span class="msg-time">${time}</span>`;
            
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // LLMì´ ì¿¼ë¦¬ë¥¼ ë¶„ì„í•´ì„œ ì ì ˆí•œ ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” ë¡œì§ (ì‹œë®¬ë ˆì´ì…˜)
        function generateChart(query) {
            const ctx = document.getElementById('aiChart').getContext('2d');
            const sqlBox = document.getElementById('sqlBox');
            sqlBox.style.display = 'block'; // SQL ë³´ì—¬ì£¼ê¸°

            // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
            if (currentChart) currentChart.destroy();

            let chartType, labels, data, colors, title, sql;

            // í‚¤ì›Œë“œì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
            if (query.includes("í•™ê³¼") || query.includes("ì „ê³µ")) {
                // ì¼€ì´ìŠ¤ 1: í•™ê³¼ë³„ ëŒ€ì¶œ
                title = "í•™ê³¼ë³„ ë„ì„œ ëŒ€ì¶œ í˜„í™© (Top 5)";
                document.getElementById('chartDesc').innerText = "ì»´í“¨í„°ê³µí•™ê³¼ì˜ ëŒ€ì¶œ ë¹ˆë„ê°€ ê°€ì¥ ë†’ê²Œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.";
                sql = "SELECT department, COUNT(*) FROM loans GROUP BY department ORDER BY count DESC LIMIT 5";
                
                chartType = 'bar';
                labels = ['ì»´í“¨í„°ê³µí•™', 'ê²½ì˜í•™', 'ë””ìì¸', 'ê°„í˜¸í•™', 'ê¸°ê³„ê³µí•™'];
                data = [120, 95, 80, 75, 60];
                colors = ['#6c5ce7', '#a29bfe', '#a29bfe', '#a29bfe', '#a29bfe']; // 1ë“± ê°•ì¡°

            } else if (query.includes("ë°©ë¬¸") || query.includes("ì‹œê°„")) {
                // ì¼€ì´ìŠ¤ 2: ì‹œê°„ëŒ€ë³„ ë°©ë¬¸
                title = "ì‹œê°„ëŒ€ë³„ ë„ì„œê´€ ì´ìš©ê° ì¶”ì´";
                document.getElementById('chartDesc').innerText = "ì˜¤í›„ 2ì‹œ~4ì‹œ ì‚¬ì´ì— ì´ìš©ê°ì´ ê°€ì¥ ë§ìŠµë‹ˆë‹¤.";
                sql = "SELECT HOUR(entry_time), COUNT(*) FROM visits GROUP BY HOUR(entry_time)";

                chartType = 'line';
                labels = ['09ì‹œ', '11ì‹œ', '13ì‹œ', '15ì‹œ', '17ì‹œ', '19ì‹œ'];
                data = [30, 80, 150, 200, 120, 60];
                colors = '#6c5ce7';

            } else {
                // ì¼€ì´ìŠ¤ 3: ê¸°ë³¸ (ì¸ê¸° ë„ì„œ) - ê·¸ ì™¸ ëª¨ë“  ì§ˆë¬¸
                title = "í˜„ì¬ ëŒ€ì¶œ ì¸ê¸°ë„ì„œ ìˆœìœ„";
                document.getElementById('chartDesc').innerText = "ìµœê·¼ 30ì¼ ê¸°ì¤€ ëŒ€ì¶œ íšŸìˆ˜ ìƒìœ„ ë„ì„œì…ë‹ˆë‹¤.";
                sql = "SELECT book_title, count FROM best_loans ORDER BY count DESC LIMIT 5";

                chartType = 'doughnut';
                labels = ['ëª¨ë˜ ìë°”ìŠ¤í¬ë¦½íŠ¸', 'ì½”ìŠ¤ëª¨ìŠ¤', 'ì±„ì‹ì£¼ì˜ì', 'íŒŒì´ì¬ ì…ë¬¸', 'ê¸°íƒ€'];
                data = [30, 25, 20, 15, 10];
                colors = ['#6c5ce7', '#a29bfe', '#74b9ff', '#81ecec', '#dfe6e9'];
            }

            // SQL í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            sqlBox.innerHTML = sql;
            document.getElementById('chartTitle').innerText = title;

            // ì°¨íŠ¸ ìƒì„±
            currentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë°ì´í„°',
                        data: data,
                        backgroundColor: colors,
                        borderColor: (chartType === 'line') ? '#6c5ce7' : null,
                        borderWidth: 1,
                        tension: 0.3,
                        fill: (chartType === 'line')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: (chartType === 'doughnut') } }
                }
            });
        }
    </script>
</body>
</html>